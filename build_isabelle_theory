#!/usr/bin/env bash
set -e

theory_root="${1:-$GITHUB_WORKSPACE}"
session_name="${2:-$(basename "$GITHUB_REPOSITORY")}"
depends="${3:-}"

build_dir="$theory_root/.build_dependencies"

mkdir -p "$build_dir"
> "$build_dir/ROOTS"

# Clone each dependency
for dep in $depends; do
  repo_url="${dep%@*}"
  repo_ref="${dep#*@}"
  repo_name=$(basename "$repo_url" .git)
  dest="$build_dir/$repo_name"

  git clone --depth 1 --branch "$repo_ref" "$repo_url" "$dest"
  echo "$dest" >> "$build_dir/ROOTS"
done

# Add the current repo to ROOTS
echo "$theory_root" >> "$build_dir/ROOTS"

# Run Isabelle build
isabelle build -d "$build_dir" -d "$theory_root" -b "$session_name"
